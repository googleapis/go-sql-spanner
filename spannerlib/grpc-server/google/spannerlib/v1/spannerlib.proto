syntax = "proto3";

package google.spannerlib.v1;

import "google/api/field_behavior.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";
import "google/rpc/status.proto";
import "google/spanner/v1/result_set.proto";
import "google/spanner/v1/spanner.proto";
import "google/spanner/v1/transaction.proto";

option csharp_namespace = "Google.Cloud.SpannerLib.V1";
option go_package = "cloud.google.com/go/spannerlib/apiv1/spannerlibpb;spannerlibpb";
option java_multiple_files = true;
option java_outer_classname = "SpannerLibProto";
option java_package = "com.google.cloud.spannerlib.v1";
option php_namespace = "Google\\Cloud\\SpannerLib\\V1";
option ruby_package = "Google::Cloud::SpannerLib::V1";

service SpannerLib {
  rpc Info(InfoRequest) returns (InfoResponse) {}

  rpc CreatePool(CreatePoolRequest) returns (Pool) {}
  rpc ClosePool(Pool) returns (google.protobuf.Empty) {}

  rpc CreateConnection(CreateConnectionRequest) returns (Connection) {}
  rpc CloseConnection(Connection) returns (google.protobuf.Empty) {}

  rpc Execute(ExecuteRequest) returns (Rows) {}
  rpc ExecuteStreaming(ExecuteRequest) returns (stream RowData) {}
  rpc ExecuteBatch(ExecuteBatchRequest) returns (google.spanner.v1.ExecuteBatchDmlResponse) {}
  rpc Metadata(Rows) returns (google.spanner.v1.ResultSetMetadata) {}
  rpc Next(NextRequest) returns (google.protobuf.ListValue) {}
  rpc ResultSetStats(Rows) returns (google.spanner.v1.ResultSetStats) {}
  rpc NextResultSet(Rows) returns (google.spanner.v1.ResultSetMetadata) {}
  rpc CloseRows(Rows) returns (google.protobuf.Empty) {}

  rpc BeginTransaction(BeginTransactionRequest) returns (google.protobuf.Empty) {}
  rpc Commit(Connection) returns (google.spanner.v1.CommitResponse) {}
  rpc Rollback(Connection) returns (google.protobuf.Empty) {}

  rpc WriteMutations(WriteMutationsRequest) returns (google.spanner.v1.CommitResponse) {}

  rpc ConnectionStream(stream ConnectionStreamRequest) returns (stream ConnectionStreamResponse) {}
  rpc ContinueStreaming(Rows) returns (stream RowData) {}
}

message InfoRequest {
}

message InfoResponse {
  string version = 1;
}

message CreatePoolRequest {
  string connection_string = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message CreateConnectionRequest {
  Pool pool = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message ExecuteRequest {
  Connection connection = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.ExecuteSqlRequest execute_sql_request = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
  FetchOptions fetch_options = 3;
}

message ExecuteBatchRequest {
  Connection connection = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.ExecuteBatchDmlRequest execute_batch_dml_request = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message BeginTransactionRequest {
  Connection connection = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.TransactionOptions transaction_options = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message WriteMutationsRequest {
  Connection connection = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.BatchWriteRequest.MutationGroup mutations = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message Pool {
  int64 id = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message Connection {
  Pool pool = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  int64 id = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message Rows {
  Connection connection = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  int64 id = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message NextRequest {
  Rows rows = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  FetchOptions fetch_options = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message FetchOptions {
  int64 num_rows = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  int64 encoding = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message RowData {
  string request_id = 1;
  Rows rows = 2 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.ResultSetMetadata metadata = 3;
  repeated google.protobuf.ListValue data = 4 [
    (google.api.field_behavior) = REQUIRED
  ];
  google.spanner.v1.ResultSetStats stats = 5;
  bool has_more_results = 6;
}

message MetadataRequest {
  Rows rows = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message ResultSetStatsRequest {
  Rows rows = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
}

message ConnectionStreamRequest {
  oneof request {
    ExecuteRequest execute_request = 1;
    ExecuteBatchRequest execute_batch_request = 2;
    BeginTransactionRequest begin_transaction_request = 3;
    Connection commit_request = 4;
    Connection rollback_request = 5;
    WriteMutationsRequest write_mutations_request = 6;
  }
}

message ExecuteResponse {
  Rows rows = 1 [
    (google.api.field_behavior) = REQUIRED
  ];
  repeated google.spanner.v1.ResultSet result_sets = 2;
  google.rpc.Status status = 3;
  bool has_more_results = 4;
}

message ConnectionStreamResponse {
  google.rpc.Status status = 1;
  oneof response {
    ExecuteResponse execute_response = 2;
    google.spanner.v1.ExecuteBatchDmlResponse execute_batch_response = 3;
    google.protobuf.Empty begin_transaction_response = 4;
    google.spanner.v1.CommitResponse commit_response = 5;
    google.protobuf.Empty rollback_response = 6;
    google.spanner.v1.CommitResponse write_mutations_response = 7;
  }
}
